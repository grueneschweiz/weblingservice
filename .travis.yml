services:
  - docker

install:
  - docker-compose -f docker-compose.install.yml up
  - docker-compose -f docker-compose.install.yml run composer composer require php-coveralls/php-coveralls
  - docker-compose down
  - docker-compose up -d
  - sleep 30
  - docker exec wsapp cp .env.travis .env
  - docker exec wsapp php artisan key:generate
  - docker exec wsapp php artisan migrate
  - docker exec wsapp php artisan passport:install
  - docker-compose stop

script:
  - docker-compose run -e WEBLING_API_KEY=${WEBLING_API_KEY} -e WEBLING_BASE_URL=${WEBLING_BASE_URL} app php /var/www/html/vendor/phpunit/phpunit/phpunit --configuration /var/www/html/phpunit.xml --coverage-clover /var/www/html/build/logs/clover.xml

after_success:
  - travis_retry docker-compose run -e TRAVIS=${TRAVIS} -e TRAVIS_JOB_ID=${TRAVIS_JOB_ID} app php /var/www/html/vendor/bin/php-coveralls -v

notifications:
  email: false
  slack:
    secure: JurKZAAXAGd3ntz8wOHAYV00GNCHZQmV2+duEQW8JawKnvaKAwh28/ranLCvkqoE3uDXqDQUAOo4STWit3+zIh5P08e/ENlByiVUmxrlFhRXC4vbjWJrfA7ppKRNtjySzvD4+cqQXk7a+OIfERVy+tEPPXf245lTJS+CtSWyhCLo6EMD9WohTIb9ieZel/h56R+gHYbOzxPyEhxkA13ZehlsTFdguc+JDDBRVSYPhFjZcO2cw/VS50vBPz+IKEvHzzkixhxftClIv2PBfCTIk+YaWUCIu3b6fp4AdYK7gbFQILCFZEuMBnh/cyGJDdj4+poz+ytUmoYX0BHoRwp6OGep+XpYPlNbfICQSOttI4GG2LIYOzOiFutOjgsz/18KUudzWZQ/3/XPz6cHoDn9CtNPItrI3iyTKYWyrQ6azGR2NzsMwRLflX/De3QhbJ5tLmgarJ39JiGEi8k4S6We+YDlkA8m8oeqkXag2uZ/l9TeNST8DLpA1e8ETV6XfOwv3Ra3LdDPB6PLPg4CSlfDaGEGVaAM9J3WKHc+rUBKO+St2gYdDspiTsXEazVcl7E/RAxTZPUEI2R9AIgRTSQMhflBHu5TIJJH02Iyj6NXcx/f/SHsOmYq2UzkMk0ssN48QVC8IhTMk7AJcRWPmcbDcRVcE5MZ2HmiA1/BnE+uPVY=