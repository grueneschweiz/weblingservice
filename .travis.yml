services:
  - docker

install:
  - docker-compose -f docker-compose.install.yml up
  - docker-compose -f docker-compose.install.yml run composer composer require php-coveralls/php-coveralls
  - docker-compose up -d
  - docker exec wsapp cp .env.travis .env
  - docker exec wsapp php artisan key:generate
  - docker exec wsapp php artisan migrate
  - docker exec wsapp php artisan passport:install
  - docker-compose stop

script:
  - docker-compose run -e WEBLING_API_KEY=${WEBLING_API_KEY} -e WEBLING_BASE_URL=${WEBLING_BASE_URL} app php /var/www/html/vendor/phpunit/phpunit/phpunit --configuration /var/www/html/phpunit.xml --coverage-clover /var/www/html/build/logs/clover.xml

after_success:
  - travis_retry docker-compose run -e TRAVIS=${TRAVIS} -e TRAVIS_JOB_ID=${TRAVIS_JOB_ID} app php /var/www/html/vendor/bin/php-coveralls -v

notifications:
  email: false
