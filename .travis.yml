services:
  - docker

install:
  - docker-compose -f docker-compose.install.yml up
  - docker-compose -f docker-compose.install.yml run composer composer require php-coveralls/php-coveralls
  - docker-compose down
  - docker-compose up -d
  - sleep 30
  - docker exec wsapp cp .env.travis .env
  - docker exec wsapp php artisan key:generate
  - docker exec wsapp php artisan migrate
  - docker exec wsapp php artisan passport:install
  - docker-compose stop

script:
  - docker-compose run -e WEBLING_API_KEY=${WEBLING_API_KEY} -e WEBLING_BASE_URL=${WEBLING_BASE_URL} app php /var/www/html/vendor/phpunit/phpunit/phpunit --configuration /var/www/html/phpunit.xml --coverage-clover /var/www/html/build/logs/clover.xml

after_success:
  - travis_retry docker-compose run -e TRAVIS=${TRAVIS} -e TRAVIS_JOB_ID=${TRAVIS_JOB_ID} app php /var/www/html/vendor/bin/php-coveralls -v

notifications:
  email: false
  slack:
    secure: McxZmG/0iL4XLGOfBdiTHA2cWmddZgYpWN08i7L7wRo4824ucbB58xCGsLQrbueQLTjoqs4ATNEt3gHuShYFLKscjeYmDiupuTQ44DEA8Sq03PJ/czJRnEbmutw8qxUO3gIvu2UcM6wBHHfPIesOS+k8V3r/RRQvHCNPFQzDkA4YGcekGTnj4gAAFetROK0Qc9HbRTBDuRj2Ad1yWq3O2EnCVEyzqCioQsMnxLfvikyI28fKL1PBRIZj+6IQejIekVWbTl6M/tDJW+ueHBeulJ0S9uYl03xN+Hy6u8Gs6njX/qmGo8ifMhfEN8oeWGZIx8gz8h4cRhJUwx4SWVVyMwJY9TqCzIR/FHLGXU4eIDKPb+SdIdLK4Z56u6vXPNxnFxGvZabumuWQcAnBpGlfKBzEmrZGhhzZ+8xbET4aLXUNGcuawILLBz87B5gpFgojB3jN6bAbT4lDtCaGGe/CcZJIJmUaYyXZkrH1p3uaJEjiv8hBMBM/JuGfnQxnv0JGF3FCvbtbcQ4N0XjPY3j9gEajWjTGoF3GsKyTMsGpNNAVYV/yySZxrxaJCmFEqAoOTokCSE8Wvekg35K5lo8CoEwVekEKr1q0/aK76GVOCIr/i/I7HUzJJ85UkZjZR/myQmUsqM/rqFYHL/IraRNAGjJuPozls+3XaK8rfD4YeV0=